(function(g,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(g=typeof globalThis<"u"?globalThis:g||self,c(g.PivotheadCore={}))})(this,function(g){"use strict";class c{constructor(e){this.config={...e,defaultAggregation:e.defaultAggregation||"sum",isResponsive:e.isResponsive??!0},this.state=this.initializeState(),this.processData()}initializeState(){return{data:this.config.data,processedData:{headers:[],rows:[],totals:{}},rows:this.config.rows||[],columns:this.config.columns||[],measures:this.config.measures||[],sortConfig:null,groupConfig:this.config.groupConfig||null,groups:[],selectedMeasures:this.config.measures||[],selectedDimensions:this.config.dimensions||[],selectedAggregation:this.config.defaultAggregation||"sum",formatting:this.config.formatting||{},isResponsive:this.config.isResponsive??!0,rowGroups:[],columnGroups:[]}}processData(){const{data:e,groups:s}=this.applyGroupingAndSorting(this.state.data);this.state.data=e,this.state.groups=s,this.state.processedData=this.generateProcessedData(e),this.updateAggregates()}applyGroupingAndSorting(e){let s=[...e],t=[];return this.state.sortConfig&&(s=this.applySorting(s)),this.state.groupConfig&&(t=this.createGroups(s,this.state.groupConfig)),{data:s,groups:t}}applySorting(e){const{field:s,direction:t,measureSort:a}=this.state.sortConfig;return e.sort((n,l)=>{let i=this.getFieldValue(n,s),o=this.getFieldValue(l,s);if(a){const r=this.state.measures.find(u=>u.uniqueName===s);r&&r.formula&&(i=r.formula(n),o=r.formula(l))}return typeof i=="number"&&typeof o=="number"?t==="asc"?i-o:o-i:t==="asc"?String(i).localeCompare(String(o)):String(o).localeCompare(String(i))})}getFieldValue(e,s){const t=this.state.measures.find(a=>a.uniqueName===s);return t&&t.formula?t.formula(e):e[s]}createGroups(e,s){const{rowFields:t,columnFields:a,grouper:n}=s,l=[...t,...a],i={};e.forEach(r=>{const u=n(r,l);i[u]||(i[u]={key:u,items:[],subgroups:[],aggregates:{}}),i[u].items.push(r)});const o=Object.values(i);return l.length>1&&o.forEach(r=>{r.subgroups=this.createGroups(r.items,{...s,rowFields:t.slice(1),columnFields:a.slice(1)})}),s.sort&&o.sort((r,u)=>{var h;return s.sort(r,u,((h=this.state.sortConfig)==null?void 0:h.field)||"")}),o}generateProcessedData(e){return{headers:this.generateHeaders(),rows:this.generateRows(e),totals:this.calculateTotals(e)}}generateHeaders(){return[...this.state.rows.map(e=>e.caption||e.uniqueName),...this.state.columns.map(e=>e.caption||e.uniqueName)]}generateRows(e){return e.map(s=>[...this.state.rows.map(t=>s[t.uniqueName]),...this.state.columns.map(t=>s[t.uniqueName])])}calculateTotals(e){const s={};return this.state.measures.forEach(t=>{s[t.uniqueName]=this.aggregate(e,t)}),s}aggregate(e,s){const t=e.map(a=>this.getFieldValue(a,s.uniqueName));switch(s.aggregation){case"sum":return t.reduce((a,n)=>a+(n||0),0);case"avg":return t.reduce((a,n)=>a+(n||0),0)/t.length;case"min":return Math.min(...t);case"max":return Math.max(...t);case"count":return t.length;default:return 0}}updateAggregates(){const e=s=>{this.state.measures.forEach(t=>{const a=`${t.aggregation}_${t.uniqueName}`;s.aggregates[a]=this.aggregate(s.items,t)}),s.subgroups&&s.subgroups.forEach(e)};this.state.groups.forEach(e)}sort(e,s,t=!1){this.state.sortConfig={field:e,direction:s,measureSort:t},this.processData()}group(e){this.state.groupConfig=e,this.processData()}setMeasures(e){this.state.measures=e,this.state.selectedMeasures=e,this.processData()}setDimensions(e){this.state.selectedDimensions=e,this.processData()}setAggregation(e){this.state.selectedAggregation=e,this.processData()}formatValue(e,s){const t=this.state.formatting[s];if(!t)return String(e);try{switch(t.type){case"currency":return new Intl.NumberFormat(t.locale||"en-US",{style:"currency",currency:t.currency||"USD"}).format(e);case"number":return new Intl.NumberFormat(t.locale||"en-US",{minimumFractionDigits:t.decimals||0,maximumFractionDigits:t.decimals||0}).format(e);case"percentage":return new Intl.NumberFormat(t.locale||"en-US",{style:"percent",minimumFractionDigits:t.decimals||0}).format(e);case"date":return new Date(e).toLocaleDateString(t.locale||"en-US",{dateStyle:"medium"});default:return String(e)}}catch(a){return console.error(`Error formatting value for field ${s}:`,a),String(e)}}reset(){this.state=this.initializeState(),this.processData()}getState(){return{...this.state}}}g.PivotEngine=c,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
